#!/usr/bin/env python3
"""Generate Israel Fertility Rate visualization - Cumulative births by birth cohort (age on x-axis)"""

import matplotlib.pyplot as plt
import numpy as np

# Israel fertility data (1950-2023)
data = [
    (1950, 0.163, 96.414, 281.26, 240.826, 175.429, 85.34, 31.669, 4.694, 0.344),
    (1951, 0.159, 98.635, 286.051, 245.064, 180.327, 86.77, 32.611, 4.689, 0.328),
    (1952, 0.153, 100.851, 289.632, 248.344, 183.712, 88.206, 33.313, 4.662, 0.312),
    (1953, 0.146, 99.991, 288.998, 247.582, 182.922, 87.915, 32.649, 4.714, 0.322),
    (1954, 0.116, 86.992, 269.375, 229.431, 169.261, 81.175, 27.695, 4.752, 0.379),
    (1955, 0.107, 82.449, 275.207, 233.981, 169.114, 85.118, 27.506, 4.705, 0.392),
    (1956, 0.095, 79.118, 278.68, 241.573, 169.143, 89.09, 25.526, 4.68, 0.397),
    (1957, 0.114, 71.671, 274.189, 245.791, 167.084, 89.257, 23.992, 4.638, 0.417),
    (1958, 0.137, 64.366, 269.417, 249.703, 164.903, 88.9, 22.698, 4.577, 0.432),
    (1959, 0.157, 53.329, 261.985, 260.868, 167.661, 95.834, 27.123, 4.497, 0.391),
    (1960, 0.188, 54.04, 266.673, 258.913, 166.702, 90.258, 28.883, 4.405, 0.419),
    (1961, 0.176, 47.09, 252.532, 247.397, 161.533, 83.265, 28.836, 4.275, 0.439),
    (1962, 0.154, 43.45, 244.731, 246.671, 164.277, 80.016, 28.199, 4.128, 0.447),
    (1963, 0.132, 42.14, 239.292, 248.764, 169.69, 78.964, 28.193, 3.898, 0.43),
    (1964, 0.117, 42.496, 237.698, 255.99, 176.065, 80.815, 28.689, 3.891, 0.413),
    (1965, 0.104, 41.006, 230.189, 255.463, 177.622, 81.851, 28.098, 3.91, 0.394),
    (1966, 0.093, 39.155, 217.779, 245.5, 172.825, 81.21, 25.332, 3.921, 0.372),
    (1967, 0.083, 35.674, 205.236, 236.872, 169.739, 84.242, 23.581, 3.919, 0.34),
    (1968, 0.076, 32.778, 195.544, 225.117, 172.987, 84.879, 22.752, 3.86, 0.343),
    (1969, 0.075, 36.653, 193.236, 219.532, 172.541, 85.099, 21.312, 3.667, 0.32),
    (1970, 0.077, 43.794, 199.843, 220.476, 178.496, 88.186, 21.211, 3.393, 0.287),
    (1971, 0.08, 41.646, 201.772, 225.979, 178.011, 94.349, 24.014, 3.18, 0.235),
    (1972, 0.085, 41.229, 202.452, 225.576, 171.406, 92.164, 24.233, 3.04, 0.225),
    (1973, 0.09, 39.699, 196.818, 213.694, 159.008, 87.858, 22.788, 2.894, 0.215),
    (1974, 0.094, 41.233, 202.252, 214.098, 159.743, 87.646, 22.801, 2.691, 0.206),
    (1975, 0.101, 42.054, 205.439, 210.772, 157.626, 85.759, 21.179, 2.539, 0.206),
    (1976, 0.11, 41.817, 207.116, 211.695, 157.38, 85.735, 21.18, 2.422, 0.192),
    (1977, 0.127, 40.195, 196.761, 205.568, 151.619, 81.072, 19.729, 2.348, 0.182),
    (1978, 0.147, 36.889, 186.983, 195.597, 138.207, 74.374, 18.066, 2.26, 0.181),
    (1979, 0.163, 35.987, 184.692, 196.164, 133.434, 73.608, 16.955, 2.144, 0.167),
    (1980, 0.171, 34.169, 179.736, 197.028, 131.135, 71.779, 16.213, 2.029, 0.166),
    (1981, 0.173, 31.094, 172.65, 192.481, 132.681, 70.232, 15.197, 1.881, 0.174),
    (1982, 0.173, 30.369, 174.12, 195.244, 138, 73.981, 15.578, 1.717, 0.158),
    (1983, 0.181, 29.448, 172.34, 198.539, 141.307, 72.673, 15.885, 1.591, 0.161),
    (1984, 0.166, 27.223, 166.027, 195.52, 140.7, 69.268, 16.515, 1.479, 0.166),
    (1985, 0.151, 24.578, 158.563, 195.088, 141.776, 68.846, 17.137, 1.376, 0.153),
    (1986, 0.133, 21.077, 152.083, 193.692, 141.354, 70.327, 17.528, 1.293, 0.134),
    (1987, 0.108, 19.823, 146.051, 190.847, 138.59, 70.629, 17.54, 1.249, 0.118),
    (1988, 0.094, 19.63, 143.242, 190.317, 138.433, 70.555, 16.434, 1.235, 0.114),
    (1989, 0.08, 19.21, 136.66, 187.705, 136.347, 70.443, 15.783, 1.244, 0.097),
    (1990, 0.086, 18.872, 132.724, 187.773, 139.084, 70.972, 15.519, 1.264, 0.09),
    (1991, 0.087, 19.046, 129.05, 187.49, 138.687, 71.288, 17.234, 1.367, 0.078),
    (1992, 0.08, 19.01, 125.936, 188.961, 144.826, 74.232, 17.904, 1.419, 0.069),
    (1993, 0.069, 18.854, 123.663, 188.057, 146.164, 75.917, 18.239, 1.383, 0.065),
    (1994, 0.052, 18.608, 120.405, 185.223, 147.301, 76.193, 17.753, 1.336, 0.066),
    (1995, 0.04, 18.353, 118.017, 184.804, 147.873, 76.445, 17.459, 1.328, 0.066),
    (1996, 0.039, 18.061, 116.883, 186.281, 152.062, 78.552, 18.217, 1.361, 0.064),
    (1997, 0.04, 17.509, 114.783, 185.868, 155.78, 79.408, 19.225, 1.409, 0.062),
    (1998, 0.042, 17.744, 118.016, 186.881, 157.799, 81.931, 19.919, 1.463, 0.066),
    (1999, 0.041, 17.343, 116.925, 183.016, 156.944, 81.919, 19.896, 1.496, 0.063),
    (2000, 0.033, 17.271, 117.479, 182.943, 160.853, 84.162, 20.755, 1.566, 0.066),
    (2001, 0.028, 16.816, 114.177, 177.531, 158.899, 84.789, 20.935, 1.633, 0.066),
    (2002, 0.026, 16.644, 112.312, 177.058, 160.225, 87.505, 20.942, 1.684, 0.062),
    (2003, 0.024, 16.472, 112.34, 179.332, 162.842, 89.559, 22.185, 1.746, 0.059),
    (2004, 0.02, 15.523, 108.996, 172.974, 159.655, 89.127, 22.243, 1.828, 0.06),
    (2005, 0.017, 15.006, 104.813, 168.469, 157.476, 89.567, 22.666, 1.928, 0.059),
    (2006, 0.015, 14.51, 104.883, 168.165, 161.301, 93.415, 23.3, 2.013, 0.06),
    (2007, 0.009, 14.149, 103.742, 168.462, 165.141, 95.03, 23.691, 2.056, 0.062),
    (2008, 0.008, 14.044, 105.809, 169.469, 168.66, 97.275, 24.421, 2.112, 0.063),
    (2009, 0.007, 13.728, 107.213, 169.891, 171.339, 99.383, 25.911, 2.197, 0.063),
    (2010, 0.006, 13.21, 109.084, 173.661, 176.324, 104.479, 27.625, 2.331, 0.061),
    (2011, 0.006, 12.286, 106.878, 172.993, 175.975, 104.559, 28.391, 2.471, 0.066),
    (2012, 0.005, 11.634, 108.055, 175.124, 178.477, 106.097, 29.429, 2.588, 0.07),
    (2013, 0.004, 10.315, 106.381, 174.831, 178.13, 105.786, 29.626, 2.739, 0.078),
    (2014, 0.004, 10.092, 107.092, 177.017, 181.497, 108.075, 29.64, 2.88, 0.083),
    (2015, 0.004, 9.672, 107.644, 177.802, 181.793, 107.858, 30.81, 3.042, 0.089),
    (2016, 0.003, 9.277, 107.527, 179.246, 183.248, 108.389, 31.872, 3.249, 0.1),
    (2017, 0.003, 8.863, 106.028, 179.55, 185.029, 109.966, 31.783, 3.39, 0.109),
    (2018, 0.004, 8.186, 102.993, 178.936, 183.901, 110.911, 31.724, 3.481, 0.112),
    (2019, 0.004, 7.481, 98.537, 175.163, 179.538, 110.35, 31.292, 3.615, 0.119),
    (2020, 0.003, 6.918, 93.475, 170.352, 175.679, 106.907, 29.79, 3.662, 0.132),
    (2021, 0.003, 6.759, 92.579, 172.882, 183.815, 112.417, 31.005, 3.737, 0.127),
    (2022, 0.002, 6.737, 89.542, 168.906, 179.496, 108.412, 29.715, 3.783, 0.14),
    (2023, 0.002, 6.204, 85.715, 163.682, 173.816, 103.803, 28.182, 3.743, 0.148),
]

# Age group midpoints and their column indices
age_groups = [
    (12, 1), (17, 2), (22, 3), (27, 4), (32, 5),
    (37, 6), (42, 7), (47, 8), (52, 9),
]

# Create a dictionary for quick lookup
data_dict = {d[0]: d[1:] for d in data}
years = [d[0] for d in data]
min_year, max_year = min(years), max(years)

# Calculate cumulative births for each birth cohort (with age on x-axis)
cohort_data = {}

for birth_year in range(1898, 2012):
    cohort_ages = []
    cohort_cumulative = []
    cumulative = 0

    for year in range(min_year, max_year + 1):
        age = year - birth_year

        # Find the appropriate age group
        fertility_rate = 0
        for age_mid, col_idx in age_groups:
            if age_mid - 2 <= age <= age_mid + 2:
                if year in data_dict:
                    fertility_rate = data_dict[year][col_idx - 1] * 5 / 1000
                break

        cumulative += fertility_rate
        if cumulative > 0:
            cohort_ages.append(age)
            cohort_cumulative.append(cumulative)

    if len(cohort_ages) >= 5:
        cohort_data[birth_year] = (cohort_ages, cohort_cumulative)

# Create figure
fig, ax = plt.subplots(figsize=(14, 8), facecolor='white')
ax.set_facecolor('white')

# Color map for birth cohorts
cmap = plt.cm.viridis
birth_years_to_plot = sorted([by for by in cohort_data.keys() if 1920 <= by <= 2000])

# Select cohorts to plot (every 5 years)
selected_cohorts = [by for by in birth_years_to_plot if by % 5 == 0]

# Normalize colors
norm = plt.Normalize(min(selected_cohorts), max(selected_cohorts))

for birth_year in selected_cohorts:
    if birth_year in cohort_data:
        ages_plot, cumulative = cohort_data[birth_year]
        color = cmap(norm(birth_year))
        ax.plot(ages_plot, cumulative, label=str(birth_year), color=color, linewidth=2)

# Styling
ax.set_xlabel('Age', fontsize=14, fontweight='bold')
ax.set_ylabel('Cumulative Births per Woman', fontsize=14, fontweight='bold')
ax.set_title('Israel: Cumulative Fertility by Birth Cohort', fontsize=18, fontweight='bold', pad=20)

# Legend
legend = ax.legend(title='Birth Year', loc='upper left', fontsize=8, title_fontsize=10,
                   framealpha=0.9, edgecolor='gray', ncol=2)

# Grid
ax.grid(True, alpha=0.3, linestyle='-', color='gray')
ax.set_axisbelow(True)

# Set axis limits
ax.set_xlim(15, 55)
ax.set_ylim(0, 5)

# Tick styling
ax.tick_params(axis='both', which='major', labelsize=11)

# Add colorbar
sm = plt.cm.ScalarMappable(cmap=cmap, norm=norm)
sm.set_array([])
cbar = plt.colorbar(sm, ax=ax, label='Birth Year', pad=0.02)

plt.tight_layout()

# Save
plt.savefig('/home/user/fertility/israel-fertility-map.png',
            dpi=150, facecolor='white', edgecolor='none', bbox_inches='tight')

print("PNG saved to: /home/user/fertility/israel-fertility-map.png")
